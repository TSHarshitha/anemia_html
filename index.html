<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Anemia Quick Check — Eyes & Nails</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto;max-width:920px;margin:18px auto;padding:18px}
    h1{margin-bottom:6px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{flex:1 1 320px;border-radius:10px;padding:12px;border:1px solid #ddd;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    video, canvas{width:100%;border-radius:8px;background:#000}
    button, select{padding:8px 10px;margin-top:8px;border-radius:8px;border:1px solid #bbb;background:#fff;cursor:pointer}
    .result{margin-top:10px;padding:10px;border-radius:8px}
    .low{background:#e6f7e6;border:1px solid #b6e7b6}
    .mod{background:#fff4e6;border:1px solid #ffd0a8}
    .sev{background:#ffecec;border:1px solid #ffb3b3}
    small{color:#666}
  </style>
</head>
<body>
  <h1>Anemia Quick Check — Eyes & Nails</h1>
  <p><strong>How it works:</strong> capture a photo of the <em>lower eyelid conjunctiva</em> and a <em>fingernail bed</em>. JS measures average redness and maps to a simple Early / Moderate / Severe suggestion. <em>Not diagnostic.</em></p>

  <div class="row">
    <div class="card">
      <h3>Camera Preview</h3>
      <video id="video" autoplay playsinline muted></video>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="startBtn">Start Camera</button>
        <button id="eyeCaptureBtn">Capture Eye</button>
        <button id="nailCaptureBtn">Capture Nail</button>
        <select id="cameraSelect"></select>
      </div>
      <p><small>Tip: good daylight helps. For eye: pull lower eyelid and photograph inner lining. For nail: press and release then photograph the nail bed.</small></p>
    </div>

    <div class="card">
      <h3>Captured Images</h3>
      <div>
        <strong>Eye (conjunctiva)</strong>
        <canvas id="eyeCanvas" width="320" height="240"></canvas>
        <div id="eyeInfo"></div>
      </div>
      <hr/>
      <div>
        <strong>Nail bed</strong>
        <canvas id="nailCanvas" width="320" height="240"></canvas>
        <div id="nailInfo"></div>
      </div>
      <div style="margin-top:10px">
        <button id="analyzeBtn">Analyze & Classify</button>
      </div>
    </div>
  </div>

  <div id="finalResult" style="margin-top:14px"></div>

  <script>
    // --- Utility & camera setup ---
    const video = document.getElementById('video');
    const startBtn = document.getElementById('startBtn');
    const cameraSelect = document.getElementById('cameraSelect');
    let stream = null;

    async function startCamera(deviceId) {
      if (stream) stream.getTracks().forEach(t=>t.stop());
      const constraints = {
        video: deviceId ? { deviceId: { exact: deviceId } } : { facingMode: "environment", width: { ideal: 1280 } },
        audio: false
      };
      try {
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        await populateCameras();
      } catch (err) {
        alert('Camera error: ' + err.message);
        console.error(err);
      }
    }

    async function populateCameras() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) return;
      const devices = await navigator.mediaDevices.enumerateDevices();
      const cams = devices.filter(d=>d.kind==='videoinput');
      cameraSelect.innerHTML = '';
      cams.forEach((c, i) => {
        const o = document.createElement('option');
        o.value = c.deviceId;
        o.textContent = c.label || ('Camera ' + (i+1));
        cameraSelect.appendChild(o);
      });
    }

    startBtn.onclick = ()=> startCamera();

    cameraSelect.onchange = ()=> startCamera(cameraSelect.value);

    // --- Capture handlers ---
    const eyeCanvas = document.getElementById('eyeCanvas');
    const nailCanvas = document.getElementById('nailCanvas');
    const eyeCtx = eyeCanvas.getContext('2d');
    const nailCtx = nailCanvas.getContext('2d');
    document.getElementById('eyeCaptureBtn').onclick = () => captureToCanvas(eyeCtx, eyeCanvas);
    document.getElementById('nailCaptureBtn').onclick = () => captureToCanvas(nailCtx, nailCanvas);

    function captureToCanvas(ctx, canvasEl) {
      if (!video || !video.videoWidth) return alert('Start camera first and allow permission.');
      canvasEl.width = video.videoWidth;
      canvasEl.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvasEl.width, canvasEl.height);
      // shrink to display-friendly size
      const MAXW = 640;
      if (canvasEl.width > MAXW) {
        const ratio = MAXW / canvasEl.width;
        const tmp = document.createElement('canvas');
        tmp.width = Math.round(canvasEl.width * ratio);
        tmp.height = Math.round(canvasEl.height * ratio);
        tmp.getContext('2d').drawImage(canvasEl, 0,0,tmp.width,tmp.height);
        canvasEl.width = tmp.width; canvasEl.height = tmp.height;
        ctx.drawImage(tmp,0,0);
      }
    }

    // --- Analysis: compute redness metric in a user-defined ROI or whole image ---
    function averageRedness(ctx, canvas) {
      const w = canvas.width, h = canvas.height;
      const img = ctx.getImageData(0,0,w,h);
      let total = 0, count = 0;
      // sample every 4th pixel for speed
      for (let i=0; i<img.data.length; i+=16) {
        const r = img.data[i], g = img.data[i+1], b = img.data[i+2];
        // simple "redness" index: R - (G+B)/2 normalized
        const redness = Math.max(0, r - ((g + b)/2));
        total += redness;
        count++;
      }
      const avg = total / count; // range approximately 0-255
      // Normalize to 0..1
      return Math.min(1, Math.max(0, avg / 120)); // 120 chosen empirically to scale values to 0-1
    }

    function classifyScores(eyeScore, nailScore) {
      // Weighted decision: conjunctival pallor is usually more sensitive
      const combined = (eyeScore * 0.6) + (nailScore * 0.4);
      // thresholds chosen to reflect relative pallor; these are heuristic only
      if (combined >= 0.55) return {stage:'Severe', cls:'sev', combined};
      if (combined >= 0.30) return {stage:'Moderate', cls:'mod', combined};
      return {stage:'Early (Mild)', cls:'low', combined};
    }

    document.getElementById('analyzeBtn').onclick = () => {
      // check canvases
      if (eyeCanvas.width === 0 || nailCanvas.width === 0) return alert('Capture both eye and nail images first.');
      const eyeScore = averageRedness(eyeCtx, eyeCanvas);
      const nailScore = averageRedness(nailCtx, nailCanvas);

      // show numeric info
      document.getElementById('eyeInfo').innerHTML = `Redness score: ${eyeScore.toFixed(2)}`;
      document.getElementById('nailInfo').innerHTML = `Redness score: ${nailScore.toFixed(2)}`;

      const result = classifyScores(eyeScore, nailScore);
      const out = document.getElementById('finalResult');
      out.innerHTML = `
        <div class="result ${result.cls}">
          <strong>Suggested stage:</strong> ${result.stage} <br/>
          <strong>Combined score:</strong> ${result.combined.toFixed(2)} <br/>
          <small>Note: This is a heuristic, camera-based suggestion — not a medical diagnosis.</small>
        </div>
      `;
      // extra suggestion
      let advice = '';
      if (result.stage === 'Severe') {
        advice = 'Recommendation: seek medical evaluation urgently and get a CBC (hemoglobin) test.';
      } else if (result.stage === 'Moderate') {
        advice = 'Recommendation: see your clinician and get a CBC and iron studies.';
      } else {
        advice = 'Recommendation: if you have symptoms (fatigue, breathlessness) or risk factors, consider checking CBC.';
      }
      out.innerHTML += `<p style="margin-top:8px">${advice}</p>`;
    };
  </script>

  <hr/>
  <p><small><strong>Limitations & references:</strong> Visual pallor (conjunctival or nailbed) can indicate anemia but is insensitive for mild cases and most reliable for moderate/severe disease. Spoon nails (koilonychia) suggest chronic iron deficiency in some patients. Always confirm with laboratory tests (CBC, ferritin, etc.) and clinical assessment. Sources: medical literature on conjunctival pallor and koilonychia. :contentReference[oaicite:1]{index=1}</small></p>
</body>
</html>
